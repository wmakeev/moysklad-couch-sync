const log = require('debug')('moysklad-couch-sync')

module.exports = function jsonAttachmentExpand (next) {
  return value => {
    if (value.TYPE_NAME === 'moysklad.attachmentDocument' && value.contents &&
      value.filename && value.filename.slice(-5) === '.json') {
      try {
        value.contents = JSON.parse(Buffer.from(value.contents, 'base64').toString('utf8'))
      } catch (e) {
        log(`${value.filename} file content parse failed:`, e.message)
      }
    }
    return next(value)
  }
}
